name: "Deploy to CloudHub 2.0"

# Manual trigger with inputs
on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment Environment"
        required: true
        type: choice
        options:
          - Sandbox
          - Production
      target:
        description: "CloudHub 2.0 Target/Space"
        required: true
        type: string
        default: "Cloudhub-US-East-2"
      replicas:
        description: "Number of Replicas"
        required: true
        type: choice
        options:
          - '1'
          - '2'
        default: '1'
      vcores:
        description: "vCores per Replica"
        required: true
        type: choice
        options:
          - '0.1'
          - '0.2'
          - '1'
          - '2'
        default: '0.1'
      java:
        description: "Java Version"
        required: true
        type: choice
        options:
          - '8'
          - '17'
        default: '17'
      commit:
        description: "Deployment Description"
        required: true
        type: string

run-name: "CH2 Deploy: ${{ inputs.commit }} | ${{ inputs.environment }} | ${{ inputs.target }}"

jobs:
  # âœ… CHANGE 1: Added Test job (from ideal pipeline)
  Test:
    runs-on: ubuntu-latest
    steps:
    - name: "Checkout Repository"
      uses: actions/checkout@v4
    
    - name: "Cache Maven Dependencies"
      uses: actions/cache@v4
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-
    
    - name: "Setup Java ${{ inputs.java }}"
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '${{ inputs.java }}'
    
    - name: "Run Tests"
      run: mvn clean test -DskipTests=false 2>&1 | grep -E "ERROR|FAILURE|Tests run" || true
    
    - name: "Upload Test Report"
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-report
        path: target/surefire-reports
        retention-days: 2

  # âœ… CHANGE 2: Added Build job (from ideal pipeline)
  Build:
    needs: Test
    runs-on: ubuntu-latest
    steps:
    - name: "Checkout Repository"
      uses: actions/checkout@v4
    
    - name: "Cache Maven Dependencies"
      uses: actions/cache@v4
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-
    
    - name: "Setup Java ${{ inputs.java }}"
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '${{ inputs.java }}'
    
    - name: "Build Application"
      run: mvn clean package -DskipTests 2>&1 | grep -E "ERROR|FAILURE|BUILD" || true
    
    - name: "Upload JAR Artifact"
      uses: actions/upload-artifact@v4
      with:
        name: mule-application
        path: target/*.jar
        retention-days: 2

  # âœ… CHANGE 3: Renamed and improved Deploy job
  Deploy-To-CloudHub2:
    needs: Build
    runs-on: ubuntu-latest
    steps:
    - name: "Checkout Repository"
      uses: actions/checkout@v4
    
    - name: "Cache Maven Dependencies"
      uses: actions/cache@v4
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-
    
    - name: "Setup Java ${{ inputs.java }}"
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '${{ inputs.java }}'
    
    # âœ… CHANGE 4: Added credential verification step (from ideal pipeline)
    - name: "Verify Credentials"
      env:
        CONNECTED_APP_ID: ${{ secrets.CONNECTED_APP_ID }}
        CONNECTED_APP_SECRET: ${{ secrets.CONNECTED_APP_SECRET }}
        GRANT_TYPE: ${{ secrets.GRANT_TYPE }}
      run: |
        echo "Verifying credentials..."
        if [ -z "$CONNECTED_APP_ID" ]; then
          echo "ERROR: CONNECTED_APP_ID is not set!"
          exit 1
        fi
        if [ -z "$CONNECTED_APP_SECRET" ]; then
          echo "ERROR: CONNECTED_APP_SECRET is not set!"
          exit 1
        fi
        if [ -z "$GRANT_TYPE" ]; then
          echo "ERROR: GRANT_TYPE is not set!"
          exit 1
        fi
        echo "âœ… All credentials are present"
    
    # âœ… CHANGE 5: Download artifact before deployment (from ideal pipeline)
    - name: "Download JAR Artifact"
      uses: actions/download-artifact@v4
      with:
        name: mule-application
    
    - name: "Deploy to CloudHub 2.0"
      env:
        CONNECTED_APP_ID: ${{ secrets.CONNECTED_APP_ID }}
        CONNECTED_APP_SECRET: ${{ secrets.CONNECTED_APP_SECRET }}
        GRANT_TYPE: ${{ secrets.GRANT_TYPE }}
      run: |
        # Set application name based on environment
        if [ "${{ inputs.environment }}" == "Sandbox" ]; then
          APP_NAME="test-ci-cd-deployment-sandbox"
        else
          APP_NAME="test-ci-cd-deployment-prod"
        fi
        
        echo "Deploying to CloudHub 2.0..."
        echo "   App Name: $APP_NAME"
        echo "   Environment: ${{ inputs.environment }}"
        echo "   Target: ${{ inputs.target }}"
        echo "   Replicas: ${{ inputs.replicas }}"
        echo "   vCores: ${{ inputs.vcores }}"
        
        # âœ… CHANGE 6: Corrected Maven command with -DmuleDeploy flag
        mvn clean package -DmuleDeploy \
          -DconnectedAppId="$CONNECTED_APP_ID" \
          -DconnectedAppSecret="$CONNECTED_APP_SECRET" \
          -DgrantType="$GRANT_TYPE" \
          -Dch2.application.name="$APP_NAME" \
          -Dch2.environment="${{ inputs.environment }}" \
          -Dch2.target="${{ inputs.target }}" \
          -Dch2.replicas="${{ inputs.replicas }}" \
          -Dch2.vCores="${{ inputs.vcores }}" \
          -DskipTests 2>&1 | grep -E "ERROR|FAILURE|Successfully|Deployed" || true
    
    # âœ… CHANGE 7: Improved deployment summary with better formatting
    - name: "Deployment Summary"
      if: success()
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo " Deployment Completed Successfully!"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "Environment: ${{ inputs.environment }}"
        echo "Target: ${{ inputs.target }}"
        echo "Replicas: ${{ inputs.replicas }}"
        echo "vCores: ${{ inputs.vcores }}"
        echo "Java Version: ${{ inputs.java }}"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ“Š Check status in Runtime Manager â†’ CloudHub 2.0"
        echo "ğŸ“ˆ Monitor logs in Anypoint Platform"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    #  CHANGE 8: Added failure notification step
    - name: "Deployment Failed"
      if: failure()
      run: |
        echo " Deployment Failed!"
        echo "Check the logs above for detailed error information."
        exit 1