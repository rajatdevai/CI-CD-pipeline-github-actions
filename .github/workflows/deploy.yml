name: Deploy to CloudHub 2.0

on:
  workflow_dispatch:
    inputs:
      environment:
        description: Deployment Environment
        required: true
        type: choice
        options:
          - Sandbox
          - Production
      target:
        description: CloudHub 2.0 Target/Space
        required: true
        type: string
        default: Cloudhub-US-East-2
      replicas:
        description: Number of Replicas
        required: true
        type: choice
        options:
          - '1'
          - '2'
      vcores:
        description: vCores per Replica
        required: true
        type: choice
        options:
          - '0.1'
          - '0.2'
          - '1'
          - '2'
      java:
        description: Java Version
        required: true
        type: choice
        options:
          - '8'
          - '17'
      runtime:
        description: Mule Runtime Version
        required: true
        type: choice
        options:
          - '4.9.8'
          - '4.10.0'
      commit:
        description: Deployment Description
        required: true
        type: string

run-name: CH2 Deploy - ${{ inputs.environment }} - ${{ inputs.target }}

env:
  MAVEN_CACHE: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Validate Environment
        run: |
          echo "Environment: ${{ inputs.environment }}"
          echo "Target: ${{ inputs.target }}"

  build:
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ env.MAVEN_CACHE }}
      
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ inputs.java }}
      
      - name: Build
        run: mvn clean package -DskipTests
      
      - uses: actions/upload-artifact@v4
        with:
          name: mule-app
          path: target/*.jar

  publish:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ env.MAVEN_CACHE }}
      
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ inputs.java }}
      
      - name: Check settings.xml
        run: |
          if [ -f "settings.xml" ]; then
            echo "Found settings.xml"
          else
            echo "settings.xml not found - creating placeholder"
          fi
      
      - name: Publish to Exchange
        env:
          APP_ID: ${{ secrets.CONNECTED_APP_ID }}
          APP_SECRET: ${{ secrets.CONNECTED_APP_SECRET }}
        run: |
          if [ -f "settings.xml" ]; then
            mvn deploy -s settings.xml -DskipTests
          else
            mvn deploy -DskipTests
          fi

  deploy:
    needs: publish
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ env.MAVEN_CACHE }}
      
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ inputs.java }}
      
      - name: Set App Name
        id: app-name
        run: |
          if [ "${{ inputs.environment }}" == "Sandbox" ]; then
            echo "name=myapp-sandbox" >> $GITHUB_OUTPUT
          else
            echo "name=myapp-prod" >> $GITHUB_OUTPUT
          fi
      
      - name: Deploy to CloudHub
        env:
          CLIENT_ID: ${{ secrets.CONNECTED_APP_ID }}
          CLIENT_SECRET: ${{ secrets.CONNECTED_APP_SECRET }}
        run: |
          echo "Deploying: ${{ steps.app-name.outputs.name }}"
          echo "Environment: ${{ inputs.environment }}"
          echo "Region: ${{ inputs.target }}"
          
          mvn clean deploy -DmuleDeploy \
            -DClientId="$CLIENT_ID" \
            -DClientSecret="$CLIENT_SECRET" \
            -Denvironment="${{ inputs.environment }}" \
            -Dapplication.name="${{ steps.app-name.outputs.name }}" \
            -DjavaVersion="${{ inputs.java }}" \
            -Dreplicas="${{ inputs.replicas }}" \
            -DvCores="${{ inputs.vcores }}" \
            -Dregion="${{ inputs.target }}" \
            -Druntime="${{ inputs.runtime }}" \
            -DskipTests
      
      - name: Success Message
        if: success()
        run: echo "✓ Deployment successful to ${{ inputs.environment }}"
      
      - name: Failure Message
        if: failure()
        run: echo "✗ Deployment failed"